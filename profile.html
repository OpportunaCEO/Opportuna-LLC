<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Profile ‚Äì Opportuna</title>
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <nav class="top-nav">
    <a href="index.html">üè† Home</a>
    <a href="profile.html">üë§ Profile</a>
    <a href="login.html" id="logoutBtn">üö™ Logout</a>
  </nav>

  <main class="container">
    <h2>Your Profile</h2>
    <form id="profileForm" class="form-card">
      <label>Full Name: <input type="text" id="fullName" /></label>
      <label>Bio: <textarea id="bio" rows="3"></textarea></label>
      <label>Skills (comma separated): <input type="text" id="skills" /></label>
      <label>Work Experience: <textarea id="experience" rows="4"></textarea></label>
      <label>Upload Profile Picture:
        <input type="file" id="profilePic" accept="image/*" />
      </label>
      <img id="picPreview" src="" alt="Preview" class="preview-img" style="max-width:150px; display:block; margin-top:8px;" />
      <button type="submit">Save Profile</button>
    </form>

    <hr />

    <section id="postSection">
      <h2>Post to Your Feed</h2>
      <form id="postForm" class="form-card">
        <textarea id="postText" placeholder="Share an update, opportunity, or experience..." rows="3" required></textarea>
        <button type="submit">Post</button>
      </form>
      <div id="feedContainer"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAFx0Ad-8RKji4cDNYWm1yPTkx4RpRwWM",
      authDomain: "opportuna-a14bb.firebaseapp.com",
      projectId: "opportuna-a14bb",
      storageBucket: "opportuna-a14bb.appspot.com",
      messagingSenderId: "906149069855",
      appId: "1:906149069855:web:618ed823248443db30812a",
      measurementId: "G-GJGCWL01W4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const fullNameInput = document.getElementById("fullName");
    const bioInput = document.getElementById("bio");
    const skillsInput = document.getElementById("skills");
    const experienceInput = document.getElementById("experience");
    const profilePicInput = document.getElementById("profilePic");
    const picPreview = document.getElementById("picPreview");

    const profileForm = document.getElementById("profileForm");
    const postForm = document.getElementById("postForm");
    const feedContainer = document.getElementById("feedContainer");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;
    let userProfileData = {};

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadProfile();
        loadPosts();
      } else {
        window.location.href = "login.html";
      }
    });

    logoutBtn.addEventListener("click", async e => {
      e.preventDefault();
      await signOut(auth);
      window.location.href = "login.html";
    });

    function loadProfile() {
      const users = JSON.parse(localStorage.getItem("users")) || {};
      userProfileData = users[currentUser.email] || {};
      fullNameInput.value = userProfileData.name || currentUser.displayName || "";
      bioInput.value = userProfileData.bio || "";
      skillsInput.value = userProfileData.skills || "";
      experienceInput.value = userProfileData.experience || "";
      picPreview.src = userProfileData.pic || currentUser.photoURL || "assets/default.png";
    }

    profilePicInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          picPreview.src = reader.result;
        };
        reader.readAsDataURL(file);
      }
    });

    profileForm.addEventListener("submit", e => {
      e.preventDefault();
      const users = JSON.parse(localStorage.getItem("users")) || {};
      users[currentUser.email] = {
        name: fullNameInput.value,
        bio: bioInput.value,
        skills: skillsInput.value,
        experience: experienceInput.value,
        pic: picPreview.src
      };
      localStorage.setItem("users", JSON.stringify(users));
      alert("Profile saved!");
    });

    postForm.addEventListener("submit", e => {
      e.preventDefault();
      const content = document.getElementById("postText").value.trim();
      if (!content) return;

      const posts = JSON.parse(localStorage.getItem("posts")) || [];
      posts.unshift({
        id: Date.now(),
        content,
        name: fullNameInput.value || currentUser.displayName || "Anonymous",
        avatar: picPreview.src || currentUser.photoURL || "assets/default.png",
        timestamp: new Date().toISOString(),
        likes: 0,
        comments: []
      });
      localStorage.setItem("posts", JSON.stringify(posts));
      postForm.reset();
      loadPosts();
    });

    function loadPosts() {
      const posts = JSON.parse(localStorage.getItem("posts")) || [];
      if (posts.length === 0) {
        feedContainer.innerHTML = "<p>No posts yet.</p>";
        return;
      }
      feedContainer.innerHTML = posts.map(p => `
        <article class="post-card">
          <header class="post-header">
            <img src="${p.avatar}" alt="${p.name}" class="post-avatar" />
            <div>
              <strong>${p.name}</strong><br />
              <small>${new Date(p.timestamp).toLocaleString()}</small>
            </div>
          </header>
          <p class="post-content">${p.content}</p>
        </article>
      `).join("");
    }
  </script>
</body>
</html>
