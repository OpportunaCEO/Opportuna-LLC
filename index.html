<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opportuna â€“ Home</title>
  <meta name="description" content="Opportuna is your personalized job and networking platform. Connect, share, and grow your career." />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .main-layout {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      padding: 2rem;
    }
    .feed {
      flex: 3;
    }
    .profile-widget {
      flex: 1;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
      text-align: center;
    }
    #createPostBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    #postModal {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.3);
      transition: right 0.3s ease-in-out;
      padding: 20px;
      z-index: 1000;
    }
    #postModal.open {
      right: 0;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 999;
    }
    #overlay.show {
      display: block;
    }
    #postForm button {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-center">
      <a href="index.html" class="nav-link">Home</a>
      <a href="profile.html" class="nav-link">Profile</a>
      <a href="login.html" class="nav-link" id="logoutLink">Logout</a>
    </div>
    <div class="dropdown">
      <img id="navProfilePic" class="profile-icon" src="assets/default.png" alt="User" />
      <div class="dropdown-content">
        <a href="profile.html">Edit Profile</a>
        <a href="#">Settings</a>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
  </nav>

  <div class="main-layout">
    <div class="feed">
      <h2>ðŸ“° Social Feed</h2>
      <section id="postSection"></section>
    </div>
    <aside id="profileWidget" class="profile-widget">
      <img id="widgetPic" class="widget-img" src="assets/default.png" alt="Profile Picture">
      <div id="widgetName">User Name</div>
    </aside>
  </div>

  <button id="createPostBtn">+</button>

  <div id="overlay"></div>
  <div id="postModal">
    <h3>Create a New Post</h3>
    <form id="postForm">
      <textarea id="postContent" placeholder="What's on your mind?" required style="width:100%; height:100px;"></textarea>
      <button type="submit">Post</button>
    </form>
  </div>

  <footer>
    <p>&copy; 2025 Opportuna. All rights reserved.</p>
  </footer>

  <!-- Firebase SDK + Real-time Post Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBAFx0Ad-8RKji4cDNYWm1yPTkx4RpRwWM",
      authDomain: "opportuna-a14bb.firebaseapp.com",
      projectId: "opportuna-a14bb",
      storageBucket: "opportuna-a14bb.appspot.com",
      messagingSenderId: "906149069855",
      appId: "1:906149069855:web:618ed823248443db30812a",
      measurementId: "G-GJGCWL01W4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const postsRef = collection(db, "posts");
    const postsQuery = query(postsRef, orderBy("timestamp", "desc"));

    // Auth/User Setup
    let users = {};
    try {
      users = JSON.parse(localStorage.getItem("users")) || {};
    } catch (e) {
      console.error("User parse error:", e);
    }

    const loggedInUser = localStorage.getItem("loggedInUser");
    if (!loggedInUser || !users[loggedInUser]) {
      window.location.href = "login.html";
    }

    const user = users[loggedInUser];
    const userName = user.name || "Unnamed";
    const userPic = user.pic && user.pic.trim() !== "" ? user.pic : "assets/default.png";

    // Update UI with user info
    document.getElementById("widgetName").textContent = userName;
    document.getElementById("widgetPic").src = userPic;
    document.getElementById("navProfilePic").src = userPic;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    });

    // Modal UI
    const modal = document.getElementById("postModal");
    const overlay = document.getElementById("overlay");
    const openBtn = document.getElementById("createPostBtn");

    openBtn.addEventListener("click", () => {
      modal.classList.add("open");
      overlay.classList.add("show");
    });

    overlay.addEventListener("click", () => {
      modal.classList.remove("open");
      overlay.classList.remove("show");
    });

    // Submit post to Firestore
    document.getElementById("postForm").addEventListener("submit", async e => {
      e.preventDefault();
      const content = document.getElementById("postContent").value.trim();
      if (!content) return;

      try {
        await addDoc(postsRef, {
          content,
          name: userName,
          avatar: userPic,
          timestamp: serverTimestamp(),
          likes: 0,
          comments: []
        });

        document.getElementById("postContent").value = "";
        modal.classList.remove("open");
        overlay.classList.remove("show");
      } catch (err) {
        console.error("Error posting:", err);
        alert("Post failed.");
      }
    });

    // Real-time post listener
    onSnapshot(postsQuery, snapshot => {
      const section = document.getElementById("postSection");
      section.innerHTML = "";

      snapshot.forEach(doc => {
        const p = doc.data();
        const div = document.createElement('div');
        div.className = "post-card";
        div.dataset.id = doc.id;

        div.innerHTML = `
          <div class="post-header">
            <img class="post-avatar" src="${p.avatar}" alt="avatar">
            <strong>${p.name}</strong>
            <small>${new Date(p.timestamp?.toDate?.() || Date.now()).toLocaleString()}</small>
          </div>
        `;

        const contentP = document.createElement('p');
        contentP.className = "post-content";
        contentP.textContent = p.content;

        div.appendChild(contentP);
        section.appendChild(div);
      });
    });
  </script>
</body>
</html>
