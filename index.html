<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Opportuna â€“ Home</title>
<meta name="description" content="Opportuna is your personalized job and networking platform. Connect, share, and grow your career." />
<link rel="stylesheet" href="assets/style.css" />
<style>
  body { margin:0; font-family: Arial, sans-serif; background: #f2f2f2; }
  nav.top-nav {
    background: #007bff; color: white; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center;
  }
  nav.top-nav a { color: white; text-decoration: none; margin-right: 1rem; }
  nav.top-nav .nav-center { display: flex; align-items: center; }
  nav.top-nav .profile-icon { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

  .main-layout {
    max-width: 960px; margin: 1.5rem auto; padding: 0 1rem;
  }
  .feed {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }

  #createPostBtn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 15px 20px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    z-index: 1100;
  }
  .post-card {
    border-bottom: 1px solid #ddd;
    padding: 1rem 0;
  }
  .post-header {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .post-avatar {
    width: 40px; height: 40px; border-radius: 50%;
  }
  .post-content {
    margin: 0.5rem 0 0 50px;
    white-space: pre-wrap;
  }
  .post-actions {
    margin-left: auto;
  }
  .edit-btn, .delete-btn {
    background: transparent;
    border: none;
    color: #007bff;
    cursor: pointer;
    margin-left: 8px;
    font-size: 0.9rem;
  }
  .edit-btn:hover { text-decoration: underline; }
  .delete-btn:hover { color: #dc3545; text-decoration: underline; }

  /* Modal styles */
  #overlay, #authOverlay {
    position: fixed;
    top:0; left:0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1200;
  }
  #overlay.show, #authOverlay.show {
    display: block;
  }
  #postModal, #authModal {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 400px;
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    transform: translate(-50%, -50%);
    z-index: 1300;
    display: none;
  }
  #postModal.open, #authModal.open {
    display: block;
  }
  #authModal h2 {
    margin-top: 0;
    margin-bottom: 1rem;
  }
  #authModal button {
    cursor: pointer;
  }
  #authChoiceButtons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
  }
  #signInBtn {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: bold;
    border-radius: 6px;
    flex: 2;
  }
  #signUpBtn {
    background: #e0e0e0;
    color: #333;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    flex: 1;
  }
  #authForm {
    display: none;
    flex-direction: column;
  }
  #authForm label {
    margin-top: 0.5rem;
  }
  #authForm input {
    padding: 8px;
    font-size: 1rem;
    margin-top: 0.25rem;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #authForm button[type="submit"] {
    margin-top: 1rem;
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 0;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
  #authError {
    color: red;
    margin-top: 0.5rem;
  }
</style>
</head>
<body>

<nav class="top-nav">
  <div class="nav-center">
    <a href="index.html" class="nav-link">Home</a>
  </div>
  <div class="dropdown" style="display:none" id="userDropdown">
    <img id="navProfilePic" class="profile-icon" src="assets/default.png" alt="User" />
    <div class="dropdown-content">
      <a href="profile.html">Edit Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </div>
</nav>

<div class="main-layout">
  <div class="feed">
    <h2>ðŸ“° Social Feed</h2>
    <section id="postSection"></section>
  </div>
</div>

<button id="createPostBtn" title="Create New Post" style="display:none;">+</button>

<div id="overlay"></div>
<div id="postModal">
  <h3>Create a New Post</h3>
  <form id="postForm">
    <textarea id="postContent" placeholder="What's on your mind?" required style="width:100%; height:100px;"></textarea>
    <button type="submit">Post</button>
  </form>
</div>

<!-- Auth modal -->
<div id="authOverlay"></div>
<div id="authModal">
  <h2>Welcome to Opportuna</h2>
  <p>Please sign in or sign up to continue.</p>
  <div id="authChoiceButtons">
    <button id="signInBtn">Sign In</button>
    <button id="signUpBtn">Sign Up</button>
  </div>

  <form id="authForm">
    <label for="emailInput">Email</label>
    <input type="email" id="emailInput" required />
    <label for="passwordInput">Password</label>
    <input type="password" id="passwordInput" required minlength="6" />
    <button type="submit" id="authSubmitBtn">Sign In</button>
    <div id="authError"></div>
  </form>
</div>

<footer style="text-align:center; margin:2rem 0 1rem 0; color:#777;">
  <p>&copy; 2025 Opportuna. All rights reserved.</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    serverTimestamp,
    query,
    orderBy,
    doc,
    updateDoc,
    deleteDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAFx0Ad-8RKji4cDNYWm1yPTkx4RpRwWM",
    authDomain: "opportuna-a14bb.firebaseapp.com",
    projectId: "opportuna-a14bb",
    storageBucket: "opportuna-a14bb.appspot.com",
    messagingSenderId: "906149069855",
    appId: "1:906149069855:web:618ed823248443db30812a",
    measurementId: "G-GJGCWL01W4"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI Elements
  const authModal = document.getElementById("authModal");
  const authOverlay = document.getElementById("authOverlay");
  const signInBtn = document.getElementById("signInBtn");
  const signUpBtn = document.getElementById("signUpBtn");
  const authForm = document.getElementById("authForm");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const authSubmitBtn = document.getElementById("authSubmitBtn");
  const authError = document.getElementById("authError");

  const navProfilePic = document.getElementById("navProfilePic");
  const userDropdown = document.getElementById("userDropdown");
  const logoutBtn = document.getElementById("logoutBtn");
  const createPostBtn = document.getElementById("createPostBtn");
  const postModal = document.getElementById("postModal");
  const overlay = document.getElementById("overlay");
  const postForm = document.getElementById("postForm");
  const postContent = document.getElementById("postContent");
  const postSection = document.getElementById("postSection");

  let isSignUp = false;

  // Show Auth modal and reset form
  function showAuthModal(signUp=false) {
    isSignUp = signUp;
    authModal.classList.add("open");
    authOverlay.classList.add("show");
    authError.textContent = "";
    authForm.style.display = "flex";
    authSubmitBtn.textContent = signUp ? "Sign Up" : "Sign In";
    emailInput.value = "";
    passwordInput.value = "";
  }

  // Hide Auth modal
  function hideAuthModal() {
    authModal.classList.remove("open");
    authOverlay.classList.remove("show");
  }

  signInBtn.addEventListener("click", () => showAuthModal(false));
  signUpBtn.addEventListener("click", () => showAuthModal(true));
  authOverlay.addEventListener("click", hideAuthModal);

  // Auth form submit
  authForm.addEventListener("submit", async e => {
    e.preventDefault();
    authError.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    try {
      if (isSignUp) {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // Optionally update displayName here or in profile page
        await updateProfile(userCredential.user, { displayName: email.split("@")[0] });
      } else {
        await signInWithEmailAndPassword(auth, email, password);
      }
      hideAuthModal();
    } catch (error) {
      authError.textContent = error.message;
    }
  });

  // Auth state changes
  onAuthStateChanged(auth, user => {
    if (user) {
      // Show UI for logged-in user
      userDropdown.style.display = "inline-block";
      createPostBtn.style.display = "inline-block";
      navProfilePic.src = user.photoURL || "assets/default.png";

      // Load posts in real-time
      listenForPosts();
    } else {
      // Show auth modal on page load if not logged in
      userDropdown.style.display = "none";
      createPostBtn.style.display = "none";
      navProfilePic.src = "assets/default.png";

      showAuthModal(false);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Create post modal toggling
  createPostBtn.addEventListener("click", () => {
    postModal.classList.add("open");
    overlay.classList.add("show");
    postContent.focus();
  });

  overlay.addEventListener("click", () => {
    postModal.classList.remove("open");
    overlay.classList.remove("show");
  });

  // Submit new post to Firestore
  postForm.addEventListener("submit", async e => {
    e.preventDefault();
    const content = postContent.value.trim();
    if (!content) return;

    const user = auth.currentUser;
    if (!user) {
      alert("You must be signed in to post.");
      return;
    }

    try {
      await addDoc(collection(db, "posts"), {
        content,
        name: user.displayName || "Unnamed",
        avatar: user.photoURL || "assets/default.png",
        authorUid: user.uid,
        timestamp: serverTimestamp(),
        likes: 0,
        comments: []
      });
      postContent.value = "";
      postModal.classList.remove("open");
      overlay.classList.remove("show");
    } catch (err) {
      console.error("Error posting:", err);
      alert("Failed to post.");
    }
  });

  // Real-time posts listener
  function listenForPosts() {
    const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(postsQuery, snapshot => {
      postSection.innerHTML = "";
      snapshot.forEach(docSnap => {
        const p = docSnap.data();
        const postDiv = document.createElement("div");
        postDiv.className = "post-card";

        let buttonsHTML = "";
        if (auth.currentUser && p.authorUid === auth.currentUser.uid) {
          buttonsHTML = `
            <button class="edit-btn" data-id="${docSnap.id}">Edit</button>
            <button class="delete-btn" data-id="${docSnap.id}">Delete</button>
          `;
        }

        postDiv.innerHTML = `
          <div class="post-header">
            <img class="post-avatar" src="${p.avatar || 'assets/default.png'}" alt="avatar" />
            <strong>${p.name}</strong>
            <small>${p.timestamp?.toDate ? p.timestamp.toDate().toLocaleString() : ''}</small>
            <div class="post-actions">${buttonsHTML}</div>
          </div>
          <p class="post-content"></p>
        `;

        postDiv.querySelector(".post-content").textContent = p.content;
        postSection.appendChild(postDiv);
      });

      // Add event listeners to edit/delete buttons
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const postId = e.target.dataset.id;
          const postDocRef = doc(db, "posts", postId);
          const postDoc = await getDoc(postDocRef);
          const postData = postDoc.data();

          const newContent = prompt("Edit your post:", postData.content);
          if (newContent !== null && newContent.trim() !== "") {
            await updateDoc(postDocRef, {
              content: newContent.trim()
            });
          }
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const postId = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this post?")) {
            await deleteDoc(doc(db, "posts", postId));
          }
        });
      });
    });
  }
</script>
</body>
</html>
