<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opportuna â€“ Home</title>
  <meta name="description" content="Opportuna is your personalized job and networking platform. Connect, share, and grow your career." />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .main-layout {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      padding: 2rem;
    }
    .feed {
      flex: 3;
    }
    .profile-widget {
      flex: 1;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
      text-align: center;
    }
    #createPostBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    #postModal {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.3);
      transition: right 0.3s ease-in-out;
      padding: 20px;
      z-index: 1000;
    }
    #postModal.open {
      right: 0;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 999;
    }
    #overlay.show {
      display: block;
    }
    #postForm button {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
    /* Profile icon in navbar */
    .profile-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    /* Dropdown styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #f9f9f9;
      min-width: 150px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      border-radius: 4px;
      z-index: 1001;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    .dropdown-content a {
      color: black;
      padding: 10px 12px;
      text-decoration: none;
      display: block;
    }
    .dropdown-content a:hover {
      background-color: #ddd;
    }

    /* Edit/Delete buttons */
    .post-actions {
      display: inline-block;
      margin-left: auto;
    }
    .edit-btn, .delete-btn {
      background-color: transparent;
      border: none;
      color: #007bff;
      cursor: pointer;
      margin-left: 8px;
      font-size: 0.9rem;
    }
    .edit-btn:hover {
      text-decoration: underline;
    }
    .delete-btn:hover {
      color: #dc3545;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-center">
      <a href="index.html" class="nav-link">Home</a>
      <a href="profile.html" class="nav-link">Profile</a>
      <a href="login.html" class="nav-link" id="logoutLink" style="display:none;">Logout</a>
    </div>
    <div class="dropdown">
      <img id="navProfilePic" class="profile-icon" src="assets/default.png" alt="User" />
      <div class="dropdown-content">
        <a href="profile.html">Edit Profile</a>
        <a href="#">Settings</a>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
  </nav>

  <div class="main-layout">
    <div class="feed">
      <h2>ðŸ“° Social Feed</h2>
      <section id="postSection"></section>
    </div>
    <aside id="profileWidget" class="profile-widget">
      <img id="widgetPic" class="widget-img" src="assets/default.png" alt="Profile Picture" style="width:100px; height:100px; border-radius:50%;" />
      <div id="widgetName">User Name</div>
    </aside>
  </div>

  <button id="createPostBtn" title="Create New Post">+</button>

  <div id="overlay"></div>
  <div id="postModal">
    <h3>Create a New Post</h3>
    <form id="postForm">
      <textarea id="postContent" placeholder="What's on your mind?" required style="width:100%; height:100px;"></textarea>
      <button type="submit">Post</button>
    </form>
  </div>

  <footer>
    <p>&copy; 2025 Opportuna. All rights reserved.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      query,
      orderBy,
      doc,
      updateDoc,
      deleteDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBAFx0Ad-8RKji4cDNYWm1yPTkx4RpRwWM",
      authDomain: "opportuna-a14bb.firebaseapp.com",
      projectId: "opportuna-a14bb",
      storageBucket: "opportuna-a14bb.appspot.com",
      messagingSenderId: "906149069855",
      appId: "1:906149069855:web:618ed823248443db30812a",
      measurementId: "G-GJGCWL01W4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const widgetName = document.getElementById("widgetName");
    const widgetPic = document.getElementById("widgetPic");
    const navProfilePic = document.getElementById("navProfilePic");
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutLink = document.getElementById("logoutLink");
    const postSection = document.getElementById("postSection");
    const postForm = document.getElementById("postForm");
    const postContent = document.getElementById("postContent");
    const modal = document.getElementById("postModal");
    const overlay = document.getElementById("overlay");
    const createPostBtn = document.getElementById("createPostBtn");

    // Redirect if not logged in and update UI if logged in
    onAuthStateChanged(auth, user => {
      if (user) {
        const displayName = user.displayName || "Unnamed";
        const photoURL = user.photoURL || "assets/default.png";

        widgetName.textContent = displayName;
        widgetPic.src = photoURL;
        navProfilePic.src = photoURL;

        logoutLink.style.display = "inline-block";

        // Show posts in real-time
        listenForPosts();

      } else {
        // Not logged in â†’ redirect to login page
        window.location.href = "login.html";
      }
    });

    // Logout handler
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    logoutLink.addEventListener("click", async (e) => {
      e.preventDefault();
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Modal open/close handlers
    createPostBtn.addEventListener("click", () => {
      modal.classList.add("open");
      overlay.classList.add("show");
      postContent.focus();
    });

    overlay.addEventListener("click", () => {
      modal.classList.remove("open");
      overlay.classList.remove("show");
    });

    // Submit new post to Firestore
    postForm.addEventListener("submit", async e => {
      e.preventDefault();
      const content = postContent.value.trim();
      if (!content) return;

      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to post.");
        return;
      }

      try {
        await addDoc(collection(db, "posts"), {
          content,
          name: user.displayName || "Unnamed",
          avatar: user.photoURL || "assets/default.png",
          authorUid: user.uid,
          timestamp: serverTimestamp(),
          likes: 0,
          comments: []
        });
        postContent.value = "";
        modal.classList.remove("open");
        overlay.classList.remove("show");
      } catch (err) {
        console.error("Error posting:", err);
        alert("Failed to post.");
      }
    });

    // Real-time Firestore listener for posts with Edit/Delete
    function listenForPosts() {
      const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
      onSnapshot(postsQuery, snapshot => {
        postSection.innerHTML = "";
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          const postDiv = document.createElement("div");
          postDiv.className = "post-card";

          let buttonsHTML = "";
          if (auth.currentUser && p.authorUid === auth.currentUser.uid) {
            buttonsHTML = `
              <button class="edit-btn" data-id="${docSnap.id}">Edit</button>
              <button class="delete-btn" data-id="${docSnap.id}">Delete</button>
            `;
          }

          postDiv.innerHTML = `
            <div class="post-header">
              <img class="post-avatar" src="${p.avatar || 'assets/default.png'}" alt="avatar" />
              <strong>${p.name}</strong>
              <small>${p.timestamp?.toDate ? p.timestamp.toDate().toLocaleString() : ''}</small>
              <div class="post-actions">${buttonsHTML}</div>
            </div>
            <p class="post-content"></p>
          `;

          postDiv.querySelector(".post-content").textContent = p.content;
          postSection.appendChild(postDiv);
        });

        // Attach event listeners for edit/delete buttons after rendering
        document.querySelectorAll(".edit-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const postId = e.target.dataset.id;
            const postDocRef = doc(db, "posts", postId);
            const postDoc = await getDoc(postDocRef);
            const postData = postDoc.data();

            const newContent = prompt("Edit your post:", postData.content);
            if (newContent !== null && newContent.trim() !== "") {
              await updateDoc(postDocRef, {
                content: newContent.trim()
              });
            }
          });
        });

        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const postId = e.target.dataset.id;
            if (confirm("Are you sure you want to delete this post?")) {
              await deleteDoc(doc(db, "posts", postId));
            }
          });
        });
      });
    }
  </script>
</body>
</html>
